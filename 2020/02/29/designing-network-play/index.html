<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Designing Network Play - Will</title>
  <meta name="description" content="üì° A simple session server is an online hash map. üó∫Ô∏è
 This post goes through the design process for implementing network play in Will.
It&rsquo;s my first time implementing a networked game, so design improvements certainly can be made.
Usage Scenario From players&rsquo; perspective, one game client will host a session, and other players join that session.">
  <meta name="author" content="Azriel Hoh"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Will",
    
    "url": "https:\/\/azriel.im\/will"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/azriel.im\/will"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/azriel.im\/will",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/azriel.im\/will\/2020\/02\/29\/designing-network-play\/",
          "name": "Designing network play"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Azriel Hoh"
  },
  "headline": "Designing Network Play",
  "description" : "üì° A simple session server is an online hash map. üó∫Ô∏è\n This post goes through the design process for implementing network play in Will.\nIt\x26rsquo;s my first time implementing a networked game, so design improvements certainly can be made.\nUsage Scenario From players\x26rsquo; perspective, one game client will host a session, and other players join that session.",
  "inLanguage" : "en",
  "wordCount":  991 ,
  "datePublished" : "2020-02-29T23:33:44",
  "dateModified" : "2020-02-29T23:33:44",
  "image" : "https:\/\/azriel.im\/will\/media\/will_logo.png",
  "keywords" : [ "development" ],
  "mainEntityOfPage" : "https:\/\/azriel.im\/will\/2020\/02\/29\/designing-network-play\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/azriel.im\/will",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/azriel.im\/will\/media\/will_logo.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Designing Network Play" />
<meta property="og:description" content="üì° A simple session server is an online hash map. üó∫Ô∏è
 This post goes through the design process for implementing network play in Will.
It&rsquo;s my first time implementing a networked game, so design improvements certainly can be made.
Usage Scenario From players&rsquo; perspective, one game client will host a session, and other players join that session.">
<meta property="og:image" content="https://azriel.im/will/media/will_logo.png" />
<meta property="og:url" content="https://azriel.im/will/2020/02/29/designing-network-play/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Will" />

  <meta name="twitter:title" content="Designing Network Play" />
  <meta name="twitter:description" content="üì° A simple session server is an online hash map. üó∫Ô∏è
 This post goes through the design process for implementing network play in Will.
It&rsquo;s my first time implementing a networked game, so design ‚Ä¶">
  <meta name="twitter:image" content="https://azriel.im/will/media/will_logo.png" />
  <meta name="twitter:card" content="summary" />
  <link href='https://azriel.im/will/media/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.59.1" />
  <link rel="alternate" href="https://azriel.im/will/index.xml" type="application/rss+xml" title="Will"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://azriel.im/will/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://azriel.im/will/css/syntax.css" /><link rel="stylesheet" href="https://azriel.im/will/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-122495090-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://azriel.im/will">Will</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Categories" href="https://azriel.im/will/categories">Categories</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="https://azriel.im/will/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="About" href="https://azriel.im/will/about/">About</a>
            </li>
          
        

        

        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg">Search</span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Will" href="https://azriel.im/will">
            <img class="avatar-img" src="https://azriel.im/will/media/will_logo.png" alt="Will" />
          </a>
        </div>
      </div>
    

  </div>
</nav>



  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Search Will</h4>
        </div>
        <div class="modal-body">
          <gcse:search></gcse:search>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Designing Network Play</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on 2020-02-29
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Azriel Hoh
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        

<blockquote>
<p>üì° A simple session server is an online hash map. üó∫Ô∏è</p>
</blockquote>

<p>This post goes through the design process for implementing network play in <em>Will</em>.</p>

<p>It&rsquo;s my first time implementing a networked game, so design improvements certainly can be made.</p>

<h2 id="usage-scenario">Usage Scenario</h2>

<p>From players&rsquo; perspective, one game client will host a session, and other players join that session. On top of that, each game client may have multiple players. An example scenario to support:</p>

<ol>
<li><strong>Player A and B:</strong> Host a session.</li>
<li><strong>Player C and D:</strong> Join session.</li>
<li><strong>Player E:</strong> Join session.</li>
<li>üéÆ Play.</li>
</ol>

<h2 id="solution-design">Solution Design</h2>

<h3 id="constraints">Constraints</h3>

<p>To make the process simple for players, we impose the following constraints:</p>

<ul>
<li><p>Players should not have to know about IP addresses.</p>

<ul>
<li>Asking the session host to figure out their external IP address is not a good user experience.</li>
<li>Asking session joiner to enter an IP address is not ergonomic.</li>
</ul></li>

<li><p>Players should not have to forward ports on their modem / router.</p>

<p>For an application to be the first to <em>listen</em> for network communication, the modem (exposed to the internet) must open a port, and then forward that to the computer that the application is on.</p>

<p>However, if the application <em>initiates</em> the communication, then the device it communicates with is free to communicate back, and the application can listen without the port forwarding setup.</p>

<p>Asking users to open ports is also a security concern, and hence unreasonable.</p></li>
</ul>

<h3 id="solution-selection">Solution Selection</h3>

<p>To remove the requirement for opening a port, an external server can be used to listen for incoming connections from game clients, and reply to those connections. This shifts the risk from the players to the server.</p>

<p>To make it easy for players to play together, the server manages <em>sessions</em> &ndash; groups of connected clients. The server generates a session code, to which each player joins. Entering a 4 letter code such as <code>ABCD</code> is far easier than <code>111.70.32.58</code>.</p>

<p>The server manages communication between the clients by sending control input from clients in the session to each other<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>. There are <a href="https://gafferongames.com/post/what_every_programmer_needs_to_know_about_game_networking/">other methods of game networking</a>, but for this attempt I will use the simpler method.</p>

<h3 id="conversations">&ldquo;Conversations&rdquo;</h3>

<p>To define how the game client and session server communicate, it is valuable to work out the conversation flows between those <em>two</em> participants, even if the conversation is part of a process involving more participants.</p>

<p>For example, the following steps describe the process of hosting and joining a session:</p>

<ol>
<li>The session host requests a session code from the server.</li>
<li>Server generates a session code and sends it back to the host.</li>
<li>A joining player sends a request to the server to join the session, passing in the session code.</li>
<li>The server accepts (or rejects) the join request.</li>
<li>The server notifies the session host of the joiner, so the other player is shown on screen.</li>
<li>The session host tells the server that game play should begin.</li>
<li>The server notifies all clients to begin game play.</li>
</ol>

<p>If we look at this carefully, there are two separate conversations happening &ndash; one between the session host and the server, the other between the session joiner and the server. Let&rsquo;s look at these individually:</p>

<h4 id="hosting">Hosting</h4>

<p>The conversation between session host and server happen in steps 1, 2, 5, 6, and 7:</p>

<ol>
<li>The session host requests a session code from the server.</li>
<li>Server generates a session code and sends it back to the host.</li>
<li><span style="opacity: 0.3">A joining player sends a request to the server to join the session, passing in the session code.</span></li>
<li><span style="opacity: 0.3">The server accepts (or rejects) the join request.</span></li>
<li>The server notifies the session host of the joiner, so the other player is shown on screen.</li>
<li>The session host tells the server that game play should begin.</li>
<li>The server notifies all clients to begin game play.</li>
</ol>

<h4 id="joining">Joining</h4>

<p>The conversation between session host and server happen in steps 3, 4, and 7:</p>

<ol>
<li><span style="opacity: 0.3">The session host requests a session code from the server.</span></li>
<li><span style="opacity: 0.3">Server generates a session code and sends it back to the host.</span></li>
<li>A joining player sends a request to the server to join the session, passing in the session code.</li>
<li>The server accepts (or rejects) the join request.</li>
<li><span style="opacity: 0.3">The server notifies the session host of the joiner, so the other player is shown on screen.</span></li>
<li><span style="opacity: 0.3">The session host tells the server that game play should begin.</span></li>
<li>The server notifies all clients to begin game play.</li>
</ol>

<h4 id="playing-synchronizing-input">Playing / Synchronizing Input</h4>

<p>After game play is established, both the session host and joiners have the same conversation with the server:</p>

<ol>
<li>Game client sends input to the server.</li>
<li>Server combines input from all game clients, and sends them back to each client.</li>
</ol>

<blockquote>
<p><strong>Implementation note</strong></p>

<p>It is possible to write code that sends messages that do not follow the conversation script. However, we can ensure
at compile time that the server and clients respect each conversation flow with a <em>session type</em> library such as
<a href="https://crates.io/crates/session_types"><code>session_types</code></a></p>
</blockquote>

<h2 id="more-cases">More Cases</h2>

<p>So far we&rsquo;ve looked at the simple case. There are many situations the design does not handle:</p>

<ul>
<li>How do we <em>end</em> a session cleanly?</li>
<li>What should happen when the session server crashes?</li>
<li>What should happen when a game client disconnects?</li>
<li>What if a player wants to reconnect after disconnecting?</li>
<li>What if a new player wants to connect mid-game?</li>
<li>What if game clients have different characters?</li>
</ul>

<p>For good user experience, these should all be detected, and where viable, players presented with options whether they would like to recover and continue the game.</p>

<h2 id="postamble">Postamble</h2>

<p>As always, designing and implementing something that works in the ideal case takes much effort, and yet is only a small fraction of designing something that doesn&rsquo;t break when everything else does.</p>

<p>Now there are some fuzzy blueprints, let&rsquo;s build it.</p>

<h2 id="support-me">Support Me</h2>

<p>The game is still in development; if you would like to support me, please consider becoming a <a href="https://www.patreon.com/azriel91">Patron</a>.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Alternatively, one could implement <a href="https://en.wikipedia.org/wiki/UDP_hole_punching">UDP hole punching</a>. However, I intend for the game to eventually compile to a WASM application, and may have to fallback to a HTTP request client.
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>


        
          <div class="blog-tags">
            
              <a href="https://azriel.im/will/tags/development/">development</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://azriel.im/will/2020/01/31/i-choose-ui/" data-toggle="tooltip" data-placement="top" title="I Choose UI">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://azriel.im/will/2020/03/13/join-me/" data-toggle="tooltip" data-placement="top" title="Join Me">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:mail@azriel.im" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/azriel91" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://azriel.im/">Azriel Hoh</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2020
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://azriel.im/will">Will</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.59.1</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://azriel.im/will/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://azriel.im/will/js/load-photoswipe.js"></script>



<script>
  (function() {
    var cx = '001170321302850785855:ikbend5xmbo';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>







    
  </body>
</html>

